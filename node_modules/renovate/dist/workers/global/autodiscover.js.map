{"version":3,"file":"autodiscover.js","sourceRoot":"","sources":["../../../lib/workers/global/autodiscover.ts"],"names":[],"mappings":"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","sourcesContent":["import is from '@sindresorhus/is';\nimport { minimatch } from 'minimatch';\nimport type { AllConfig } from '../../config/types';\nimport { logger } from '../../logger';\nimport { platform } from '../../modules/platform';\nimport { configRegexPredicate, isConfigRegex } from '../../util/regex';\n\n// istanbul ignore next\nfunction repoName(value: string | { repository: string }): string {\n  return String(is.string(value) ? value : value.repository).toLowerCase();\n}\n\nexport async function autodiscoverRepositories(\n  config: AllConfig\n): Promise<AllConfig> {\n  if (config.platform === 'local') {\n    if (config.repositories?.length) {\n      logger.debug(\n        { repositories: config.repositories },\n        'Found repositories when in local mode'\n      );\n      throw new Error(\n        'Invalid configuration: repositories list not supported when platform=local'\n      );\n    }\n    config.repositories = ['local'];\n    return config;\n  }\n  if (!config.autodiscover) {\n    if (!config.repositories?.length) {\n      logger.warn(\n        'No repositories found - did you want to run with flag --autodiscover?'\n      );\n    }\n    return config;\n  }\n  // Autodiscover list of repositories\n  let discovered = await platform.getRepos({\n    topics: config.autodiscoverTopics,\n    includeMirrors: config.includeMirrors,\n  });\n  if (!discovered?.length) {\n    // Soft fail (no error thrown) if no accessible repositories\n    logger.debug(\n      'The account associated with your token does not have access to any repos'\n    );\n    return config;\n  }\n\n  if (config.autodiscoverFilter) {\n    discovered = applyFilters(\n      discovered,\n      is.string(config.autodiscoverFilter)\n        ? [config.autodiscoverFilter]\n        : config.autodiscoverFilter\n    );\n\n    if (!discovered.length) {\n      // Soft fail (no error thrown) if no accessible repositories match the filter\n      logger.debug('None of the discovered repositories matched the filter');\n      return config;\n    }\n  }\n\n  logger.info(\n    { length: discovered.length, repositories: discovered },\n    `Autodiscovered repositories`\n  );\n\n  // istanbul ignore if\n  if (config.repositories?.length) {\n    logger.debug(\n      'Checking autodiscovered repositories against configured repositories'\n    );\n    for (const configuredRepo of config.repositories) {\n      const repository = repoName(configuredRepo);\n      let found = false;\n      for (let i = discovered.length - 1; i > -1; i -= 1) {\n        if (repository === repoName(discovered[i])) {\n          found = true;\n          logger.debug({ repository }, 'Using configured repository settings');\n          // TODO: fix typings\n          discovered[i] = configuredRepo as never;\n        }\n      }\n      if (!found) {\n        logger.warn(\n          { repository },\n          'Configured repository is in not in autodiscover list'\n        );\n      }\n    }\n  }\n  return { ...config, repositories: discovered };\n}\n\nexport function applyFilters(repos: string[], filters: string[]): string[] {\n  const matched = new Set<string>();\n\n  for (const filter of filters) {\n    let res: string[];\n    if (isConfigRegex(filter)) {\n      const autodiscoveryPred = configRegexPredicate(filter);\n      if (!autodiscoveryPred) {\n        throw new Error(`Failed to parse regex pattern \"${filter}\"`);\n      }\n      res = repos.filter(autodiscoveryPred);\n    } else {\n      res = repos.filter(minimatch.filter(filter, { nocase: true }));\n    }\n    for (const repository of res) {\n      matched.add(repository);\n    }\n  }\n  return [...matched];\n}\n"]}