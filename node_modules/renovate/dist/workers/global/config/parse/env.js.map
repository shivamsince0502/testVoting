{"version":3,"file":"env.js","sourceRoot":"","sources":["../../../../../lib/workers/global/config/parse/env.ts"],"names":[],"mappings":"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","sourcesContent":["import is from '@sindresorhus/is';\nimport JSON5 from 'json5';\nimport { getOptions } from '../../../../config/options';\nimport type { AllConfig } from '../../../../config/types';\nimport { logger } from '../../../../logger';\nimport { coersions } from './coersions';\nimport type { ParseConfigOptions } from './types';\n\nfunction normalizePrefixes(\n  env: NodeJS.ProcessEnv,\n  prefix: string | undefined\n): NodeJS.ProcessEnv {\n  const result = { ...env };\n  if (prefix) {\n    for (const [key, val] of Object.entries(result)) {\n      if (key.startsWith(prefix)) {\n        const newKey = key.replace(prefix, 'RENOVATE_');\n        result[newKey] = val;\n        delete result[key];\n      }\n    }\n  }\n  return result;\n}\n\nexport function getEnvName(option: ParseConfigOptions): string {\n  if (option.env === false) {\n    return '';\n  }\n  if (option.env) {\n    return option.env;\n  }\n  const nameWithUnderscores = option.name.replace(/([A-Z])/g, '_$1');\n  return `RENOVATE_${nameWithUnderscores.toUpperCase()}`;\n}\n\nconst renameKeys = {\n  aliases: 'registryAliases',\n  azureAutoComplete: 'platformAutomerge', // migrate: azureAutoComplete\n  gitLabAutomerge: 'platformAutomerge', // migrate: gitLabAutomerge\n};\n\nfunction renameEnvKeys(env: NodeJS.ProcessEnv): NodeJS.ProcessEnv {\n  const result = { ...env };\n  for (const [from, to] of Object.entries(renameKeys)) {\n    const fromKey = getEnvName({ name: from });\n    const toKey = getEnvName({ name: to });\n    if (env[fromKey]) {\n      result[toKey] = env[fromKey];\n      delete result[fromKey];\n    }\n  }\n  return result;\n}\n\nconst migratedKeysWithValues = [\n  {\n    oldName: 'recreateClosed',\n    newName: 'recreateWhen',\n    from: 'true',\n    to: 'always',\n  },\n  {\n    oldName: 'recreateClosed',\n    newName: 'recreateWhen',\n    from: 'false',\n    to: 'auto',\n  },\n];\n\nfunction massageEnvKeyValues(env: NodeJS.ProcessEnv): NodeJS.ProcessEnv {\n  const result = { ...env };\n  for (const { oldName, newName, from, to } of migratedKeysWithValues) {\n    const key = getEnvName({ name: oldName });\n    if (env[key] !== undefined) {\n      if (result[key] === from) {\n        delete result[key];\n        result[getEnvName({ name: newName })] = to;\n      }\n    }\n  }\n  return result;\n}\n\nexport function getConfig(inputEnv: NodeJS.ProcessEnv): AllConfig {\n  let env = inputEnv;\n  env = normalizePrefixes(inputEnv, inputEnv.ENV_PREFIX);\n  env = renameEnvKeys(env);\n  // massage the values of migrated configuration keys\n  env = massageEnvKeyValues(env);\n\n  const options = getOptions();\n\n  let config: AllConfig = {};\n\n  if (env.RENOVATE_CONFIG) {\n    try {\n      config = JSON5.parse(env.RENOVATE_CONFIG);\n      logger.debug({ config }, 'Detected config in env RENOVATE_CONFIG');\n    } catch (err) {\n      logger.fatal({ err }, 'Could not parse RENOVATE_CONFIG');\n      process.exit(1);\n    }\n  }\n\n  config.hostRules ||= [];\n\n  options.forEach((option) => {\n    if (option.env !== false) {\n      const envName = getEnvName(option);\n      const envVal = env[envName];\n      if (envVal) {\n        if (option.type === 'array' && option.subType === 'object') {\n          try {\n            const parsed = JSON5.parse(envVal);\n            if (is.array(parsed)) {\n              config[option.name] = parsed;\n            } else {\n              logger.debug(\n                { val: envVal, envName },\n                'Could not parse object array'\n              );\n            }\n          } catch (err) {\n            logger.debug(\n              { val: envVal, envName },\n              'Could not parse environment variable'\n            );\n          }\n        } else {\n          const coerce = coersions[option.type];\n          config[option.name] = coerce(envVal);\n          if (option.name === 'dryRun') {\n            if ((config[option.name] as string) === 'true') {\n              logger.warn(\n                'env config dryRun property has been changed to full'\n              );\n              config[option.name] = 'full';\n            } else if ((config[option.name] as string) === 'false') {\n              logger.warn(\n                'env config dryRun property has been changed to null'\n              );\n              delete config[option.name];\n            } else if ((config[option.name] as string) === 'null') {\n              delete config[option.name];\n            }\n          }\n          if (option.name === 'requireConfig') {\n            if ((config[option.name] as string) === 'true') {\n              logger.warn(\n                'env config requireConfig property has been changed to required'\n              );\n              config[option.name] = 'required';\n            } else if ((config[option.name] as string) === 'false') {\n              logger.warn(\n                'env config requireConfig property has been changed to optional'\n              );\n              config[option.name] = 'optional';\n            }\n          }\n        }\n      }\n    }\n  });\n\n  if (env.GITHUB_COM_TOKEN) {\n    if (env.GITHUB_COM_TOKEN.startsWith('github_pat_')) {\n      logger.warn(\n        'GITHUB_COM_TOKEN: Fine-grained Personal Access Tokens do not support the GitHub GraphQL API. Use a classic PAT instead.'\n      );\n    } else {\n      logger.debug(`Converting GITHUB_COM_TOKEN into a global host rule`);\n      config.hostRules.push({\n        hostType: 'github',\n        matchHost: 'github.com',\n        token: env.GITHUB_COM_TOKEN,\n      });\n    }\n  }\n\n  // These env vars are deprecated and deleted to make sure they're not used\n  const unsupportedEnv = [\n    'BITBUCKET_TOKEN',\n    'BITBUCKET_USERNAME',\n    'BITBUCKET_PASSWORD',\n    'GITHUB_ENDPOINT',\n    'GITHUB_TOKEN',\n    'GITLAB_ENDPOINT',\n    'GITLAB_TOKEN',\n    'VSTS_ENDPOINT',\n    'VSTS_TOKEN',\n  ];\n\n  unsupportedEnv.forEach((val) => delete env[val]);\n\n  return config;\n}\n"]}