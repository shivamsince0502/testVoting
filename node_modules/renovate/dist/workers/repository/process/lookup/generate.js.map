{"version":3,"file":"generate.js","sourceRoot":"","sources":["../../../../../lib/workers/repository/process/lookup/generate.ts"],"names":[],"mappings":"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","sourcesContent":["import is from '@sindresorhus/is';\nimport { logger } from '../../../../logger';\nimport type { Release } from '../../../../modules/datasource';\nimport type { LookupUpdate } from '../../../../modules/manager/types';\nimport type { VersioningApi } from '../../../../modules/versioning';\nimport type { RangeStrategy } from '../../../../types';\nimport { getMergeConfidenceLevel } from '../../../../util/merge-confidence';\nimport type { LookupUpdateConfig } from './types';\nimport { getUpdateType } from './update-type';\n\nexport async function generateUpdate(\n  config: LookupUpdateConfig,\n  versioning: VersioningApi,\n  rangeStrategy: RangeStrategy,\n  currentVersion: string,\n  bucket: string,\n  release: Release\n): Promise<LookupUpdate> {\n  const newVersion = release.version;\n  const update: LookupUpdate = {\n    bucket,\n    newVersion,\n    newValue: null!,\n  };\n\n  // istanbul ignore if\n  if (release.checksumUrl !== undefined) {\n    update.checksumUrl = release.checksumUrl;\n  }\n  // istanbul ignore if\n  if (release.downloadUrl !== undefined) {\n    update.downloadUrl = release.downloadUrl;\n  }\n  // istanbul ignore if\n  if (release.newDigest !== undefined) {\n    update.newDigest = release.newDigest;\n  }\n  // istanbul ignore if\n  if (release.releaseTimestamp !== undefined) {\n    update.releaseTimestamp = release.releaseTimestamp;\n  }\n  // istanbul ignore if\n  if (release.registryUrl !== undefined) {\n    /**\n     * This means:\n     *  - registry strategy is set to merge\n     *  - releases were fetched from multiple registry urls\n     */\n    update.registryUrl = release.registryUrl;\n  }\n\n  const { currentValue } = config;\n  if (currentValue) {\n    try {\n      update.newValue = versioning.getNewValue({\n        currentValue,\n        rangeStrategy,\n        currentVersion,\n        newVersion,\n      })!;\n    } catch (err) /* istanbul ignore next */ {\n      logger.warn(\n        { err, currentValue, rangeStrategy, currentVersion, newVersion },\n        'getNewValue error'\n      );\n      update.newValue = currentValue;\n    }\n  } else {\n    update.newValue = currentValue!;\n  }\n  update.newMajor = versioning.getMajor(newVersion)!;\n  update.newMinor = versioning.getMinor(newVersion)!;\n  // istanbul ignore if\n  if (!update.updateType && !currentVersion) {\n    logger.debug({ update }, 'Update has no currentVersion');\n    update.newValue = currentValue!;\n    return update;\n  }\n  update.updateType =\n    update.updateType ??\n    getUpdateType(config, versioning, currentVersion, newVersion);\n  const { datasource, packageName, packageRules } = config;\n  if (packageRules?.some((pr) => is.nonEmptyArray(pr.matchConfidence))) {\n    update.mergeConfidenceLevel = await getMergeConfidenceLevel(\n      datasource,\n      packageName,\n      currentVersion,\n      newVersion,\n      update.updateType\n    );\n  }\n  if (!versioning.isVersion(update.newValue)) {\n    update.isRange = true;\n  }\n  if (rangeStrategy === 'update-lockfile' && currentValue === update.newValue) {\n    update.isLockfileUpdate = true;\n  }\n  if (\n    rangeStrategy === 'bump' &&\n    // TODO #7154\n    versioning.matches(newVersion, currentValue!)\n  ) {\n    update.isBump = true;\n  }\n  return update;\n}\n"]}