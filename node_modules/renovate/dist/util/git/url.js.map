{"version":3,"file":"url.js","sourceRoot":"","sources":["../../../lib/util/git/url.ts"],"names":[],"mappings":";;;;AAAA,0EAAwC;AACxC,yCAAsC;AACtC,sCAA2C;AAC3C,iEAA2C;AAC3C,oCAAiC;AAEjC,SAAgB,WAAW,CAAC,GAAW;IACrC,OAAO,IAAA,uBAAW,EAAC,GAAG,CAAC,CAAC;AAC1B,CAAC;AAFD,kCAEC;AAED,SAAgB,UAAU,CAAC,GAAW,EAAE,KAAc;IACpD,MAAM,SAAS,GAAG,WAAW,CAAC,GAAG,CAAC,CAAC;IAEnC,MAAM,QAAQ,GAAG,IAAA,aAAK,EAAC,UAAU,CAAC,CAAC,IAAI,CAAC,SAAS,CAAC,QAAQ,CAAC;QACzD,CAAC,CAAC,SAAS,CAAC,QAAQ;QACpB,CAAC,CAAC,OAAO,CAAC;IAEZ,SAAS,CAAC,KAAK,GAAG,KAAK,IAAI,EAAE,CAAC;IAE9B,IAAI,KAAK,EAAE;QACT,QAAQ,IAAA,uBAAc,EAAC,SAAS,CAAC,QAAQ,CAAC,QAAQ,CAAC,CAAC,EAAE;YACpD,KAAK,QAAQ;gBACX,SAAS,CAAC,KAAK,GAAG,KAAK,CAAC,QAAQ,CAAC,GAAG,CAAC;oBACnC,CAAC,CAAC,KAAK;oBACP,CAAC,CAAC,mBAAmB,KAAK,EAAE,CAAC;gBAC/B,MAAM;YACR,KAAK,QAAQ;gBACX,SAAS,CAAC,KAAK,GAAG,KAAK,CAAC,QAAQ,CAAC,GAAG,CAAC;oBACnC,CAAC,CAAC,KAAK;oBACP,CAAC,CAAC,kBAAkB,KAAK,EAAE,CAAC;gBAC9B,MAAM;SACT;KACF;IAED,OAAO,SAAS,CAAC,QAAQ,CAAC,QAAQ,CAAC,CAAC;AACtC,CAAC;AAzBD,gCAyBC;AAED,SAAgB,qBAAqB,CAAC,GAAW,EAAE,QAAiB;IAClE,IAAI,UAAkB,CAAC;IAEvB,IAAI;QACF,UAAU,GAAG,UAAU,CAAC,GAAG,CAAC,CAAC;KAC9B;IAAC,MAAM;QACN,eAAM,CAAC,IAAI,CAAC,EAAE,GAAG,EAAE,EAAE,kDAAkD,CAAC,CAAC;QAEzE,UAAU,GAAG,GAAG,CAAC;KAClB;IAED,MAAM,QAAQ,GAAG,SAAS,CAAC,IAAI,CAAC,EAAE,GAAG,EAAE,UAAU,EAAE,QAAQ,EAAE,CAAC,CAAC;IAE/D,IAAI,QAAQ,EAAE,KAAK,EAAE;QACnB,eAAM,CAAC,KAAK,CAAC,iCAAiC,GAAG,EAAE,CAAC,CAAC;QAErD,OAAO,UAAU,CAAC,GAAG,EAAE,kBAAkB,CAAC,QAAQ,CAAC,KAAK,CAAC,CAAC,CAAC;KAC5D;IAED,IAAI,QAAQ,EAAE,QAAQ,IAAI,QAAQ,EAAE,QAAQ,EAAE;QAC5C,eAAM,CAAC,KAAK,CAAC,iDAAiD,GAAG,EAAE,CAAC,CAAC;QACrE,MAAM,eAAe,GAAG,kBAAkB,CAAC,QAAQ,CAAC,QAAQ,CAAC,CAAC;QAC9D,MAAM,eAAe,GAAG,kBAAkB,CAAC,QAAQ,CAAC,QAAQ,CAAC,CAAC;QAE9D,OAAO,UAAU,CAAC,GAAG,EAAE,GAAG,eAAe,IAAI,eAAe,EAAE,CAAC,CAAC;KACjE;IAED,OAAO,GAAG,CAAC;AACb,CAAC;AA5BD,sDA4BC","sourcesContent":["import gitUrlParse from 'git-url-parse';\nimport { logger } from '../../logger';\nimport { detectPlatform } from '../common';\nimport * as hostRules from '../host-rules';\nimport { regEx } from '../regex';\n\nexport function parseGitUrl(url: string): gitUrlParse.GitUrl {\n  return gitUrlParse(url);\n}\n\nexport function getHttpUrl(url: string, token?: string): string {\n  const parsedUrl = parseGitUrl(url);\n\n  const protocol = regEx(/^https?$/).exec(parsedUrl.protocol)\n    ? parsedUrl.protocol\n    : 'https';\n\n  parsedUrl.token = token ?? '';\n\n  if (token) {\n    switch (detectPlatform(parsedUrl.toString(protocol))) {\n      case 'gitlab':\n        parsedUrl.token = token.includes(':')\n          ? token\n          : `gitlab-ci-token:${token}`;\n        break;\n      case 'github':\n        parsedUrl.token = token.includes(':')\n          ? token\n          : `x-access-token:${token}`;\n        break;\n    }\n  }\n\n  return parsedUrl.toString(protocol);\n}\n\nexport function getRemoteUrlWithToken(url: string, hostType?: string): string {\n  let coercedUrl: string;\n\n  try {\n    coercedUrl = getHttpUrl(url);\n  } catch {\n    logger.warn({ url }, `Attempting to use non-git url for git operations`);\n\n    coercedUrl = url;\n  }\n\n  const hostRule = hostRules.find({ url: coercedUrl, hostType });\n\n  if (hostRule?.token) {\n    logger.debug(`Found hostRules token for url ${url}`);\n\n    return getHttpUrl(url, encodeURIComponent(hostRule.token));\n  }\n\n  if (hostRule?.username && hostRule?.password) {\n    logger.debug(`Found hostRules username and password for url ${url}`);\n    const encodedUsername = encodeURIComponent(hostRule.username);\n    const encodedPassword = encodeURIComponent(hostRule.password);\n\n    return getHttpUrl(url, `${encodedUsername}:${encodedPassword}`);\n  }\n\n  return url;\n}\n"]}