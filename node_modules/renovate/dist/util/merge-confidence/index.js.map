{"version":3,"file":"index.js","sourceRoot":"","sources":["../../../lib/util/merge-confidence/index.ts"],"names":[],"mappings":"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","sourcesContent":["import is from '@sindresorhus/is';\nimport type { UpdateType } from '../../config/types';\nimport { logger } from '../../logger';\nimport { ExternalHostError } from '../../types/errors/external-host-error';\nimport * as packageCache from '../cache/package';\nimport * as hostRules from '../host-rules';\nimport { Http } from '../http';\nimport { MERGE_CONFIDENCE } from './common';\nimport type { MergeConfidence } from './types';\n\nconst hostType = 'merge-confidence';\nconst http = new Http(hostType);\nlet token: string | undefined;\nlet apiBaseUrl: string | undefined;\n\nconst supportedDatasources = ['npm', 'maven', 'pypi'];\n\nexport const confidenceLevels: Record<MergeConfidence, number> = {\n  low: -1,\n  neutral: 0,\n  high: 1,\n  'very high': 2,\n};\n\nexport function initConfig(): void {\n  apiBaseUrl = getApiBaseUrl();\n  token = getApiToken();\n  if (!is.nullOrUndefined(token)) {\n    logger.debug(`Merge confidence token found for ${apiBaseUrl}`);\n  }\n}\n\nexport function resetConfig(): void {\n  token = undefined;\n  apiBaseUrl = undefined;\n}\n\nexport function isMergeConfidence(value: string): value is MergeConfidence {\n  return MERGE_CONFIDENCE.includes(value as MergeConfidence);\n}\n\nexport function isActiveConfidenceLevel(confidence: string): boolean {\n  return isMergeConfidence(confidence) && confidence !== 'low';\n}\n\nexport function satisfiesConfidenceLevel(\n  confidence: MergeConfidence,\n  minimumConfidence: MergeConfidence\n): boolean {\n  return confidenceLevels[confidence] >= confidenceLevels[minimumConfidence];\n}\n\nconst updateTypeConfidenceMapping: Record<UpdateType, MergeConfidence | null> =\n  {\n    pin: 'high',\n    digest: 'neutral',\n    pinDigest: 'high',\n    bump: 'neutral',\n    lockFileMaintenance: 'neutral',\n    lockfileUpdate: 'neutral',\n    rollback: 'neutral',\n    replacement: 'neutral',\n    major: null,\n    minor: null,\n    patch: null,\n  };\n\n/**\n * Retrieves the merge confidence of a package update if the merge confidence API is enabled. Otherwise, undefined is returned.\n *\n * @param datasource\n * @param packageName\n * @param currentVersion\n * @param newVersion\n * @param updateType\n *\n * @returns The merge confidence level for the given package release.\n * @throws {ExternalHostError} If a request has been made and an error occurs during the request, such as a timeout, connection reset, authentication failure, or internal server error.\n */\nexport async function getMergeConfidenceLevel(\n  datasource: string,\n  packageName: string,\n  currentVersion: string,\n  newVersion: string,\n  updateType: UpdateType\n): Promise<MergeConfidence | undefined> {\n  if (is.nullOrUndefined(apiBaseUrl) || is.nullOrUndefined(token)) {\n    return undefined;\n  }\n\n  if (!supportedDatasources.includes(datasource)) {\n    return undefined;\n  }\n\n  if (!(currentVersion && newVersion && updateType)) {\n    return 'neutral';\n  }\n\n  const mappedConfidence = updateTypeConfidenceMapping[updateType];\n  if (mappedConfidence) {\n    return mappedConfidence;\n  }\n\n  return await queryApi(datasource, packageName, currentVersion, newVersion);\n}\n\n/**\n * Queries the Merge Confidence API with the given package release information.\n *\n * @param datasource\n * @param packageName\n * @param currentVersion\n * @param newVersion\n *\n * @returns The merge confidence level for the given package release.\n * @throws {ExternalHostError} if a timeout or connection reset error, authentication failure, or internal server error occurs during the request.\n *\n * @remarks\n * Results are cached for 60 minutes to reduce the number of API calls.\n */\nasync function queryApi(\n  datasource: string,\n  packageName: string,\n  currentVersion: string,\n  newVersion: string\n): Promise<MergeConfidence> {\n  // istanbul ignore if: defensive, already been validated before calling this function\n  if (is.nullOrUndefined(apiBaseUrl) || is.nullOrUndefined(token)) {\n    return 'neutral';\n  }\n\n  const escapedPackageName = packageName.replace('/', '%2f');\n  const url = `${apiBaseUrl}api/mc/json/${datasource}/${escapedPackageName}/${currentVersion}/${newVersion}`;\n  const cacheKey = `${token}:${url}`;\n  const cachedResult = await packageCache.get(hostType, cacheKey);\n\n  // istanbul ignore if\n  if (cachedResult) {\n    logger.debug(\n      {\n        datasource,\n        packageName,\n        currentVersion,\n        newVersion,\n        cachedResult,\n      },\n      'using merge confidence cached result'\n    );\n    return cachedResult;\n  }\n\n  let confidence: MergeConfidence = 'neutral';\n  try {\n    const res = (await http.getJson<{ confidence: MergeConfidence }>(url)).body;\n    if (isMergeConfidence(res.confidence)) {\n      confidence = res.confidence;\n    }\n  } catch (err) {\n    apiErrorHandler(err);\n  }\n\n  await packageCache.set(hostType, cacheKey, confidence, 60);\n  return confidence;\n}\n\n/**\n * Checks the health of the Merge Confidence API by attempting to authenticate with it.\n *\n * @returns Resolves when the API health check is completed successfully.\n *\n * @throws {ExternalHostError} if a timeout, connection reset error, authentication failure, or internal server error occurs during the request.\n *\n * @remarks\n * This function first checks that the API base URL and an authentication bearer token are defined before attempting to\n * authenticate with the API. If either the base URL or token is not defined, it will immediately return\n * without making a request.\n */\nexport async function initMergeConfidence(): Promise<void> {\n  initConfig();\n\n  if (is.nullOrUndefined(apiBaseUrl) || is.nullOrUndefined(token)) {\n    logger.trace('merge confidence API usage is disabled');\n    return;\n  }\n\n  const url = `${apiBaseUrl}api/mc/availability`;\n  try {\n    await http.get(url);\n  } catch (err) {\n    apiErrorHandler(err);\n  }\n\n  logger.debug('merge confidence API - successfully authenticated');\n  return;\n}\n\nfunction getApiBaseUrl(): string {\n  const defaultBaseUrl = 'https://developer.mend.io/';\n  const baseFromEnv = process.env.RENOVATE_X_MERGE_CONFIDENCE_API_BASE_URL;\n\n  if (is.nullOrUndefined(baseFromEnv)) {\n    logger.trace('using default merge confidence API base URL');\n    return defaultBaseUrl;\n  }\n\n  try {\n    const parsedBaseUrl = new URL(baseFromEnv).toString();\n    logger.trace(\n      { baseUrl: parsedBaseUrl },\n      'using merge confidence API base found in environment variables'\n    );\n    return parsedBaseUrl;\n  } catch (err) {\n    logger.warn(\n      { err, baseFromEnv },\n      'invalid merge confidence API base URL found in environment variables - using default value instead'\n    );\n    return defaultBaseUrl;\n  }\n}\n\nexport function getApiToken(): string | undefined {\n  return hostRules.find({\n    url: apiBaseUrl,\n    hostType,\n  })?.token;\n}\n\n/**\n * Handles errors returned by the Merge Confidence API.\n *\n * @param err - The error object returned by the API.\n * @throws {ExternalHostError} if a timeout or connection reset error, authentication failure, or internal server error occurs during the request.\n */\nfunction apiErrorHandler(err: any): void {\n  if (err.code === 'ETIMEDOUT' || err.code === 'ECONNRESET') {\n    logger.error({ err }, 'merge confidence API request failed - aborting run');\n    throw new ExternalHostError(err, hostType);\n  }\n\n  if (err.statusCode === 403) {\n    logger.error({ err }, 'merge confidence API token rejected - aborting run');\n    throw new ExternalHostError(err, hostType);\n  }\n\n  if (err.statusCode >= 500 && err.statusCode < 600) {\n    logger.error({ err }, 'merge confidence API failure: 5xx - aborting run');\n    throw new ExternalHostError(err, hostType);\n  }\n\n  logger.warn({ err }, 'error fetching merge confidence data');\n}\n"]}