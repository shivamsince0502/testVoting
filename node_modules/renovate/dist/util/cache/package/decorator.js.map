{"version":3,"file":"decorator.js","sourceRoot":"","sources":["../../../../lib/util/cache/package/decorator.ts"],"names":[],"mappings":"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","sourcesContent":["import is from '@sindresorhus/is';\nimport { DateTime } from 'luxon';\nimport { GlobalConfig } from '../../../config/global';\nimport { logger } from '../../../logger';\nimport { Decorator, decorate } from '../../decorator';\nimport type { DecoratorCachedRecord } from './types';\nimport * as packageCache from '.';\n\ntype HashFunction<T extends any[] = any[]> = (...args: T) => string;\ntype BooleanFunction<T extends any[] = any[]> = (...args: T) => boolean;\n\n/**\n * The cache decorator parameters.\n */\ninterface CacheParameters {\n  /**\n   * The cache namespace\n   * Either a string or a hash function that generates a string\n   */\n  namespace: string | HashFunction;\n\n  /**\n   * The cache key\n   * Either a string or a hash function that generates a string\n   */\n  key: string | HashFunction;\n\n  /**\n   * A function that returns true if a result is cacheable\n   * Used to prevent caching of private, sensitive, results\n   */\n  cacheable?: BooleanFunction;\n\n  /**\n   * The TTL (or expiry) of the key in minutes\n   */\n  ttlMinutes?: number;\n}\n\n/**\n * caches the result of a decorated method.\n */\nexport function cache<T>({\n  namespace,\n  key,\n  cacheable = () => true,\n  ttlMinutes = 30,\n}: CacheParameters): Decorator<T> {\n  return decorate(async ({ args, instance, callback, methodName }) => {\n    if (!cacheable.apply(instance, args)) {\n      return callback();\n    }\n\n    let finalNamespace: string | undefined;\n    if (is.string(namespace)) {\n      finalNamespace = namespace;\n    } else if (is.function_(namespace)) {\n      finalNamespace = namespace.apply(instance, args);\n    }\n\n    let finalKey: string | undefined;\n    if (is.string(key)) {\n      finalKey = key;\n    } else if (is.function_(key)) {\n      finalKey = key.apply(instance, args);\n    }\n\n    // istanbul ignore if\n    if (!finalNamespace || !finalKey) {\n      return callback();\n    }\n\n    finalKey = `cache-decorator:${finalKey}`;\n    const oldRecord = await packageCache.get<DecoratorCachedRecord>(\n      finalNamespace,\n      finalKey\n    );\n\n    const softTtl = ttlMinutes;\n\n    const cacheHardTtlMinutes = GlobalConfig.get('cacheHardTtlMinutes', 0);\n    let hardTtl = softTtl;\n    if (methodName === 'getReleases' || methodName === 'getDigest') {\n      hardTtl = Math.max(softTtl, cacheHardTtlMinutes);\n    }\n\n    let oldData: unknown;\n    if (oldRecord) {\n      const now = DateTime.local();\n      const cachedAt = DateTime.fromISO(oldRecord.cachedAt);\n\n      const softDeadline = cachedAt.plus({ minutes: softTtl });\n      if (now < softDeadline) {\n        return oldRecord.value;\n      }\n\n      const hardDeadline = cachedAt.plus({ minutes: hardTtl });\n      if (now < hardDeadline) {\n        oldData = oldRecord.value;\n      }\n    }\n\n    let newData: unknown;\n    if (oldData) {\n      try {\n        newData = (await callback()) as T | undefined;\n      } catch (err) {\n        logger.debug(\n          { err },\n          'Package cache decorator: callback error, returning old data'\n        );\n        return oldData;\n      }\n    } else {\n      newData = (await callback()) as T | undefined;\n    }\n\n    if (!is.undefined(newData)) {\n      const newRecord: DecoratorCachedRecord = {\n        cachedAt: DateTime.local().toISO()!,\n        value: newData,\n      };\n      await packageCache.set(finalNamespace, finalKey, newRecord, hardTtl);\n    }\n\n    return newData;\n  });\n}\n"]}