{"version":3,"file":"index.js","sourceRoot":"","sources":["../../../../lib/modules/datasource/gradle-version/index.ts"],"names":[],"mappings":"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","sourcesContent":["import { cache } from '../../../util/cache/package/decorator';\nimport { regEx } from '../../../util/regex';\nimport * as gradleVersioning from '../../versioning/gradle';\nimport { Datasource } from '../datasource';\nimport type { GetReleasesConfig, Release, ReleaseResult } from '../types';\nimport type { GradleRelease } from './types';\n\nexport class GradleVersionDatasource extends Datasource {\n  static readonly id = 'gradle-version';\n\n  constructor() {\n    super(GradleVersionDatasource.id);\n  }\n\n  override readonly defaultRegistryUrls = [\n    'https://services.gradle.org/versions/all',\n  ];\n\n  override readonly defaultVersioning = gradleVersioning.id;\n\n  override readonly registryStrategy = 'merge';\n\n  private static readonly buildTimeRegex = regEx(\n    '^(\\\\d\\\\d\\\\d\\\\d)(\\\\d\\\\d)(\\\\d\\\\d)(\\\\d\\\\d)(\\\\d\\\\d)(\\\\d\\\\d)(\\\\+\\\\d\\\\d\\\\d\\\\d)$'\n  );\n\n  @cache({\n    namespace: `datasource-${GradleVersionDatasource.id}`,\n    // TODO: types (#7154)\n    // eslint-disable-next-line @typescript-eslint/restrict-template-expressions\n    key: ({ registryUrl }: GetReleasesConfig) => `${registryUrl}`,\n  })\n  async getReleases({\n    registryUrl,\n  }: GetReleasesConfig): Promise<ReleaseResult | null> {\n    // istanbul ignore if\n    if (!registryUrl) {\n      return null;\n    }\n\n    let releases: Release[];\n    try {\n      const response = await this.http.getJson<GradleRelease[]>(registryUrl);\n      releases = response.body\n        .filter((release) => !release.snapshot && !release.nightly)\n        .map((release) => {\n          const { version, buildTime } = release;\n\n          const gitRef = GradleVersionDatasource.getGitRef(release.version);\n\n          const releaseTimestamp =\n            GradleVersionDatasource.formatBuildTime(buildTime);\n\n          const result: Release = { version, gitRef, releaseTimestamp };\n\n          if (release.broken) {\n            result.isDeprecated = true;\n          }\n\n          return result;\n        });\n    } catch (err) {\n      this.handleGenericErrors(err);\n    }\n\n    const res: ReleaseResult = {\n      releases,\n      homepage: 'https://gradle.org',\n      sourceUrl: 'https://github.com/gradle/gradle',\n    };\n    if (res.releases.length) {\n      return res;\n    }\n    return null;\n  }\n\n  private static formatBuildTime(timeStr: string): string | null {\n    if (!timeStr) {\n      return null;\n    }\n    if (GradleVersionDatasource.buildTimeRegex.test(timeStr)) {\n      return timeStr.replace(\n        GradleVersionDatasource.buildTimeRegex,\n        '$1-$2-$3T$4:$5:$6$7'\n      );\n    }\n    return null;\n  }\n\n  /**\n   * Calculate `gitTag` based on `version`:\n   *   - `8.1.2` -> `v8.1.2`\n   *   - `8.2` -> `v8.2.0`\n   *   - `8.2-rc-1` -> `v8.2.0-RC1`\n   *   - `8.2-milestone-1` -> `v8.2.0-M1`\n   */\n  private static getGitRef(version: string): string {\n    const [versionPart, typePart, unstablePart] = version.split(/-([a-z]+)-/);\n\n    let suffix = '';\n    if (typePart === 'rc') {\n      suffix = `-RC${unstablePart}`;\n    } else if (typePart === 'milestone') {\n      suffix = `-M${unstablePart}`;\n    }\n\n    const [major, minor, patch = '0'] = versionPart.split('.');\n    return `v${major}.${minor}.${patch}${suffix}`;\n  }\n}\n"]}