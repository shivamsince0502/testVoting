{"version":3,"file":"extract.js","sourceRoot":"","sources":["../../../../lib/modules/manager/helmfile/extract.ts"],"names":[],"mappings":"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","sourcesContent":["import is from '@sindresorhus/is';\nimport { loadAll } from 'js-yaml';\nimport { logger } from '../../../logger';\nimport { regEx } from '../../../util/regex';\nimport { DockerDatasource } from '../../datasource/docker';\nimport { HelmDatasource } from '../../datasource/helm';\nimport type {\n  ExtractConfig,\n  PackageDependency,\n  PackageFileContent,\n} from '../types';\nimport type { Doc } from './types';\nimport {\n  kustomizationsKeysUsed,\n  localChartHasKustomizationsYaml,\n} from './utils';\n\nconst isValidChartName = (name: string | undefined): boolean =>\n  !!name && !regEx(/[!@#$%^&*(),.?\":{}/|<>A-Z]/).test(name);\n\nfunction extractYaml(content: string): string {\n  // regex remove go templated ({{ . }}) values\n  return content\n    .replace(regEx(/{{`.+?`}}/gs), '')\n    .replace(regEx(/{{.+?}}/g), '');\n}\n\nfunction isLocalPath(possiblePath: string): boolean {\n  return ['./', '../', '/'].some((localPrefix) =>\n    possiblePath.startsWith(localPrefix)\n  );\n}\n\nexport async function extractPackageFile(\n  content: string,\n  packageFile: string,\n  config: ExtractConfig\n): Promise<PackageFileContent | null> {\n  const deps: PackageDependency[] = [];\n  let docs: Doc[];\n  const registryAliases: Record<string, string> = {};\n  // Record kustomization usage for all deps, since updating artifacts is run on the helmfile.yaml as a whole.\n  let needKustomize = false;\n  try {\n    docs = loadAll(extractYaml(content), null, { json: true }) as Doc[];\n  } catch (err) {\n    logger.debug(\n      { err, packageFile },\n      'Failed to parse helmfile helmfile.yaml'\n    );\n    return null;\n  }\n  for (const doc of docs) {\n    if (!(doc && is.array(doc.releases))) {\n      continue;\n    }\n\n    if (doc.repositories) {\n      for (let i = 0; i < doc.repositories.length; i += 1) {\n        registryAliases[doc.repositories[i].name] = doc.repositories[i].url;\n      }\n    }\n    logger.debug({ registryAliases }, 'repositories discovered.');\n\n    for (const dep of doc.releases) {\n      let depName = dep.chart;\n      let repoName: string | null = null;\n\n      if (!is.string(dep.chart)) {\n        deps.push({\n          depName: dep.name,\n          skipReason: 'invalid-name',\n        });\n        continue;\n      }\n\n      // If it starts with ./ ../ or / then it's a local path\n      if (isLocalPath(dep.chart)) {\n        if (\n          kustomizationsKeysUsed(dep) ||\n          (await localChartHasKustomizationsYaml(dep, packageFile))\n        ) {\n          needKustomize = true;\n        }\n        deps.push({\n          depName: dep.name,\n          skipReason: 'local-chart',\n        });\n        continue;\n      }\n\n      if (is.number(dep.version)) {\n        dep.version = String(dep.version);\n      }\n\n      if (dep.chart.includes('/')) {\n        const v = dep.chart.split('/');\n        repoName = v.shift()!;\n        depName = v.join('/');\n      } else {\n        repoName = dep.chart;\n      }\n\n      if (!is.string(dep.version)) {\n        deps.push({\n          depName,\n          skipReason: 'invalid-version',\n        });\n        continue;\n      }\n\n      const res: PackageDependency = {\n        depName,\n        currentValue: dep.version,\n        registryUrls: [registryAliases[repoName]]\n          .concat([config.registryAliases?.[repoName]] as string[])\n          .filter(is.string),\n      };\n      if (kustomizationsKeysUsed(dep)) {\n        needKustomize = true;\n      }\n      // in case of OCI repository, we need a PackageDependency with a DockerDatasource and a packageName\n      const repository = doc.repositories?.find(\n        (repo) => repo.name === repoName\n      );\n      if (repository?.oci) {\n        res.datasource = DockerDatasource.id;\n        res.packageName = registryAliases[repoName] + '/' + depName;\n      }\n\n      // By definition on helm the chart name should be lowercase letter + number + -\n      // However helmfile support templating of that field\n      if (!isValidChartName(res.depName)) {\n        res.skipReason = 'unsupported-chart-type';\n      }\n\n      // Skip in case we cannot locate the registry\n      if (is.emptyArray(res.registryUrls)) {\n        res.skipReason = 'unknown-registry';\n      }\n\n      deps.push(res);\n    }\n  }\n\n  return deps.length\n    ? {\n        deps,\n        datasource: HelmDatasource.id,\n        ...(needKustomize && { managerData: { needKustomize } }),\n      }\n    : null;\n}\n"]}