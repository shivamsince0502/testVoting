{"version":3,"file":"locked-versions.js","sourceRoot":"","sources":["../../../../../lib/modules/manager/npm/extract/locked-versions.ts"],"names":[],"mappings":"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","sourcesContent":["import is from '@sindresorhus/is';\nimport semver from 'semver';\nimport { dirname, relative } from 'upath';\nimport { logger } from '../../../../logger';\nimport type { PackageFile } from '../../types';\nimport type { NpmManagerData } from '../types';\nimport { getNpmLock } from './npm';\nimport { getPnpmLock } from './pnpm';\nimport type { LockFile } from './types';\nimport { getYarnLock } from './yarn';\n\nexport async function getLockedVersions(\n  packageFiles: PackageFile<NpmManagerData>[]\n): Promise<void> {\n  const lockFileCache: Record<string, LockFile> = {};\n  logger.debug('Finding locked versions');\n  for (const packageFile of packageFiles) {\n    const { managerData = {} } = packageFile;\n    const { yarnLock, npmLock, pnpmShrinkwrap } = managerData;\n    const lockFiles: string[] = [];\n    if (yarnLock) {\n      logger.trace('Found yarnLock');\n      lockFiles.push(yarnLock);\n      if (!lockFileCache[yarnLock]) {\n        logger.trace(`Retrieving/parsing ${yarnLock}`);\n        lockFileCache[yarnLock] = await getYarnLock(yarnLock);\n      }\n      const { lockfileVersion, isYarn1 } = lockFileCache[yarnLock];\n      let yarn: string | undefined;\n      if (!isYarn1 && !packageFile.extractedConstraints?.yarn) {\n        if (lockfileVersion && lockfileVersion >= 8) {\n          // https://github.com/yarnpkg/berry/commit/9bcd27ae34aee77a567dd104947407532fa179b3\n          yarn = '^3.0.0';\n        } else if (lockfileVersion && lockfileVersion >= 6) {\n          // https://github.com/yarnpkg/berry/commit/f753790380cbda5b55d028ea84b199445129f9ba\n          yarn = '^2.2.0';\n        } else {\n          yarn = '^2.0.0';\n        }\n      }\n      if (yarn) {\n        packageFile.extractedConstraints ??= {};\n        packageFile.extractedConstraints.yarn = yarn;\n      }\n      for (const dep of packageFile.deps) {\n        dep.lockedVersion =\n          lockFileCache[yarnLock].lockedVersions?.[\n            // TODO: types (#7154)\n            // eslint-disable-next-line @typescript-eslint/restrict-template-expressions\n            `${dep.depName}@${dep.currentValue}`\n          ];\n        if (\n          (dep.depType === 'engines' || dep.depType === 'packageManager') &&\n          dep.depName === 'yarn' &&\n          !isYarn1\n        ) {\n          dep.packageName = '@yarnpkg/cli';\n        }\n      }\n    } else if (npmLock) {\n      logger.debug(`Found ${npmLock} for ${packageFile.packageFile}`);\n      lockFiles.push(npmLock);\n      if (!lockFileCache[npmLock]) {\n        logger.trace('Retrieving/parsing ' + npmLock);\n        const cache = await getNpmLock(npmLock);\n        // istanbul ignore if\n        if (!cache) {\n          logger.warn({ npmLock }, 'Npm: unable to get lockfile');\n          return;\n        }\n        lockFileCache[npmLock] = cache;\n      }\n\n      const { lockfileVersion } = lockFileCache[npmLock];\n      let npm: string | undefined;\n      if (lockfileVersion === 1) {\n        if (packageFile.extractedConstraints?.npm) {\n          // Add a <7 constraint if it's not already a fixed version\n          if (\n            semver.satisfies('6.14.18', packageFile.extractedConstraints.npm)\n          ) {\n            npm = packageFile.extractedConstraints.npm + ' <7';\n          }\n        } else {\n          npm = '<7';\n        }\n      } else if (lockfileVersion === 2) {\n        if (packageFile.extractedConstraints?.npm) {\n          // Add a <9 constraint if the latest 8.x is compatible\n          if (\n            semver.satisfies('8.19.3', packageFile.extractedConstraints.npm)\n          ) {\n            npm = packageFile.extractedConstraints.npm + ' <9';\n          }\n        } else {\n          npm = '<9';\n        }\n      } else if (lockfileVersion === 3) {\n        if (!packageFile.extractedConstraints?.npm) {\n          npm = '>=7';\n        }\n      } else {\n        logger.warn(\n          { lockfileVersion, npmLock },\n          'Found unsupported npm lockfile version'\n        );\n        return;\n      }\n      if (npm) {\n        packageFile.extractedConstraints ??= {};\n        packageFile.extractedConstraints.npm = npm;\n      }\n\n      for (const dep of packageFile.deps) {\n        // TODO: types (#7154)\n        dep.lockedVersion = semver.valid(\n          lockFileCache[npmLock].lockedVersions?.[dep.depName!]\n        )!;\n      }\n    } else if (pnpmShrinkwrap) {\n      logger.debug('Found pnpm lock-file');\n      lockFiles.push(pnpmShrinkwrap);\n      if (!lockFileCache[pnpmShrinkwrap]) {\n        logger.trace(`Retrieving/parsing ${pnpmShrinkwrap}`);\n        lockFileCache[pnpmShrinkwrap] = await getPnpmLock(pnpmShrinkwrap);\n      }\n\n      const packageDir = dirname(packageFile.packageFile);\n      const pnpmRootDir = dirname(pnpmShrinkwrap);\n      const relativeDir = relative(pnpmRootDir, packageDir) || '.';\n\n      for (const dep of packageFile.deps) {\n        const { depName, depType } = dep;\n        // TODO: types (#7154)\n        const lockedVersion = semver.valid(\n          lockFileCache[pnpmShrinkwrap].lockedVersionsWithPath?.[relativeDir]?.[\n            depType!\n          ]?.[depName!]\n        );\n        if (is.string(lockedVersion)) {\n          dep.lockedVersion = lockedVersion;\n        }\n      }\n    }\n    if (lockFiles.length) {\n      packageFile.lockFiles = lockFiles;\n    }\n  }\n}\n"]}