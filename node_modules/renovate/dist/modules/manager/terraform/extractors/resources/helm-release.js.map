{"version":3,"file":"helm-release.js","sourceRoot":"","sources":["../../../../../../lib/modules/manager/terraform/extractors/resources/helm-release.ts"],"names":[],"mappings":";;;;AAAA,kEAAkC;AAClC,kDAA+C;AAC/C,iDAAuD;AACvD,sDAA6D;AAC7D,yDAAqD;AACrD,iDAAsD;AAEtD,qCAAiD;AAGjD,qCAAiD;AAEjD,MAAa,oBAAqB,SAAQ,0BAAmB;IAC3D,YAAY;QACV,OAAO,CAAC,gBAAgB,CAAC,CAAC;IAC5B,CAAC;IAEQ,OAAO,CACd,MAA+B,EAC/B,MAAsB,EACtB,MAAqB;QAErB,MAAM,YAAY,GAAG,EAAE,CAAC;QAExB,MAAM,YAAY,GAAG,MAAM,EAAE,QAAQ,EAAE,YAAY,CAAC;QACpD,IAAI,YAAE,CAAC,eAAe,CAAC,YAAY,CAAC,EAAE;YACpC,OAAO,EAAE,CAAC;SACX;QAED,qBAAqB;QACrB,IAAI,CAAC,YAAE,CAAC,WAAW,CAAC,YAAY,CAAC,EAAE;YACjC,eAAM,CAAC,KAAK,CACV,EAAE,YAAY,EAAE,EAChB,4CAA4C,CAC7C,CAAC;YACF,OAAO,EAAE,CAAC;SACX;QAED,KAAK,MAAM,WAAW,IAAI,MAAM,CAAC,MAAM,CAAC,YAAY,CAAC,CAAC,IAAI,EAAE,EAAE;YAC5D,MAAM,GAAG,GAAsB;gBAC7B,YAAY,EAAE,WAAW,CAAC,OAAO;gBACjC,OAAO,EAAE,cAAc;gBACvB,OAAO,EAAE,WAAW,CAAC,KAAK;gBAC1B,UAAU,EAAE,qBAAc,CAAC,EAAE;aAC9B,CAAC;YAEF,YAAY,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC;YAEvB,IAAI,CAAC,YAAE,CAAC,cAAc,CAAC,WAAW,CAAC,KAAK,CAAC,EAAE;gBACzC,GAAG,CAAC,UAAU,GAAG,cAAc,CAAC;aACjC;iBAAM,IAAI,IAAA,qBAAa,EAAC,WAAW,CAAC,KAAK,CAAC,EAAE;gBAC3C,qEAAqE;gBACrE,GAAG,CAAC,OAAO,GAAG,WAAW,CAAC,KAAK,CAAC,OAAO,CAAC,QAAQ,EAAE,EAAE,CAAC,CAAC;gBACtD,IAAI,CAAC,UAAU,CAAC,GAAG,CAAC,OAAO,EAAE,MAAM,EAAE,GAAG,CAAC,CAAC;aAC3C;iBAAM,IAAI,IAAA,0BAAmB,EAAC,WAAW,CAAC,KAAK,CAAC,EAAE;gBACjD,GAAG,CAAC,UAAU,GAAG,aAAa,CAAC;aAChC;iBAAM,IAAI,YAAE,CAAC,cAAc,CAAC,WAAW,CAAC,UAAU,CAAC,EAAE;gBACpD,IAAI,IAAA,qBAAa,EAAC,WAAW,CAAC,UAAU,CAAC,EAAE;oBACzC,qEAAqE;oBACrE,IAAI,CAAC,UAAU,CACb,IAAA,kBAAY,EACV,WAAW,CAAC,UAAU,CAAC,OAAO,CAAC,QAAQ,EAAE,EAAE,CAAC,EAC5C,WAAW,CAAC,KAAK,CAClB,EACD,MAAM,EACN,GAAG,CACJ,CAAC;iBACH;qBAAM;oBACL,GAAG,CAAC,YAAY,GAAG,CAAC,WAAW,CAAC,UAAU,CAAC,CAAC;iBAC7C;aACF;SACF;QAED,OAAO,YAAY,CAAC;IACtB,CAAC;IAEO,UAAU,CAChB,OAAe,EACf,MAAqB,EACrB,GAAsB;QAEtB,MAAM,EAAE,OAAO,EAAE,WAAW,EAAE,UAAU,EAAE,GAAG,IAAA,gBAAM,EACjD,OAAO,EACP,KAAK,EACL,MAAM,CAAC,eAAe,CACvB,CAAC;QACF,GAAG,CAAC,WAAW,GAAG,WAAW,CAAC;QAC9B,GAAG,CAAC,UAAU,GAAG,UAAU,CAAC;IAC9B,CAAC;CACF;AA7ED,oDA6EC","sourcesContent":["import is from '@sindresorhus/is';\nimport { logger } from '../../../../../logger';\nimport { joinUrlParts } from '../../../../../util/url';\nimport { HelmDatasource } from '../../../../datasource/helm';\nimport { getDep } from '../../../dockerfile/extract';\nimport { isOCIRegistry } from '../../../helmv3/utils';\nimport type { ExtractConfig, PackageDependency } from '../../../types';\nimport { DependencyExtractor } from '../../base';\nimport type { TerraformDefinitionFile } from '../../hcl/types';\nimport type { ProviderLock } from '../../lockfile/types';\nimport { checkIfStringIsPath } from '../../util';\n\nexport class HelmReleaseExtractor extends DependencyExtractor {\n  getCheckList(): string[] {\n    return [`\"helm_release\"`];\n  }\n\n  override extract(\n    hclMap: TerraformDefinitionFile,\n    _locks: ProviderLock[],\n    config: ExtractConfig\n  ): PackageDependency[] {\n    const dependencies = [];\n\n    const helmReleases = hclMap?.resource?.helm_release;\n    if (is.nullOrUndefined(helmReleases)) {\n      return [];\n    }\n\n    // istanbul ignore if\n    if (!is.plainObject(helmReleases)) {\n      logger.debug(\n        { helmReleases },\n        'Terraform: unexpected `helmReleases` value'\n      );\n      return [];\n    }\n\n    for (const helmRelease of Object.values(helmReleases).flat()) {\n      const dep: PackageDependency = {\n        currentValue: helmRelease.version,\n        depType: 'helm_release',\n        depName: helmRelease.chart,\n        datasource: HelmDatasource.id,\n      };\n\n      dependencies.push(dep);\n\n      if (!is.nonEmptyString(helmRelease.chart)) {\n        dep.skipReason = 'invalid-name';\n      } else if (isOCIRegistry(helmRelease.chart)) {\n        // For oci charts, we remove the oci:// and use the docker datasource\n        dep.depName = helmRelease.chart.replace('oci://', '');\n        this.processOCI(dep.depName, config, dep);\n      } else if (checkIfStringIsPath(helmRelease.chart)) {\n        dep.skipReason = 'local-chart';\n      } else if (is.nonEmptyString(helmRelease.repository)) {\n        if (isOCIRegistry(helmRelease.repository)) {\n          // For oci charts, we remove the oci:// and use the docker datasource\n          this.processOCI(\n            joinUrlParts(\n              helmRelease.repository.replace('oci://', ''),\n              helmRelease.chart\n            ),\n            config,\n            dep\n          );\n        } else {\n          dep.registryUrls = [helmRelease.repository];\n        }\n      }\n    }\n\n    return dependencies;\n  }\n\n  private processOCI(\n    depName: string,\n    config: ExtractConfig,\n    dep: PackageDependency\n  ): void {\n    const { depName: packageName, datasource } = getDep(\n      depName,\n      false,\n      config.registryAliases\n    );\n    dep.packageName = packageName;\n    dep.datasource = datasource;\n  }\n}\n"]}