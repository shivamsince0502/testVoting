{"version":3,"file":"extract.js","sourceRoot":"","sources":["../../../../lib/modules/manager/kustomize/extract.ts"],"names":[],"mappings":"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","sourcesContent":["import is from '@sindresorhus/is';\nimport { load } from 'js-yaml';\nimport { logger } from '../../../logger';\nimport { coerceArray } from '../../../util/array';\nimport { regEx } from '../../../util/regex';\nimport { DockerDatasource } from '../../datasource/docker';\nimport { GitTagsDatasource } from '../../datasource/git-tags';\nimport { GithubTagsDatasource } from '../../datasource/github-tags';\nimport { HelmDatasource } from '../../datasource/helm';\nimport { splitImageParts } from '../dockerfile/extract';\nimport type { PackageDependency, PackageFileContent } from '../types';\nimport type { HelmChart, Image, Kustomize } from './types';\n\n// URL specifications should follow the hashicorp URL format\n// https://github.com/hashicorp/go-getter#url-format\nconst gitUrl = regEx(\n  /^(?:git::)?(?<url>(?:(?:(?:http|https|ssh):\\/\\/)?(?:.*@)?)?(?<path>(?:[^:/\\s]+(?::[0-9]+)?[:/])?(?<project>[^/\\s]+\\/[^/\\s]+)))(?<subdir>[^?\\s]*)\\?ref=(?<currentValue>.+)$/\n);\n// regex to match URLs with \".git\" delimiter\nconst dotGitRegex = regEx(\n  /^(?:git::)?(?<url>(?:(?:(?:http|https|ssh):\\/\\/)?(?:.*@)?)?(?<path>(?:[^:/\\s]+(?::[0-9]+)?[:/])?(?<project>[^?\\s]*(\\.git))))(?<subdir>[^?\\s]*)\\?ref=(?<currentValue>.+)$/\n);\n// regex to match URLs with \"_git\" delimiter\nconst underscoreGitRegex = regEx(\n  /^(?:git::)?(?<url>(?:(?:(?:http|https|ssh):\\/\\/)?(?:.*@)?)?(?<path>(?:[^:/\\s]+(?::[0-9]+)?[:/])?(?<project>[^?\\s]*)(_git\\/[^/\\s]+)))(?<subdir>[^?\\s]*)\\?ref=(?<currentValue>.+)$/\n);\n// regex to match URLs having an extra \"//\"\nconst gitUrlWithPath = regEx(\n  /^(?:git::)?(?<url>(?:(?:(?:http|https|ssh):\\/\\/)?(?:.*@)?)?(?<path>(?:[^:/\\s]+(?::[0-9]+)?[:/])(?<project>[^?\\s]+)))(?:\\/\\/)(?<subdir>[^?\\s]+)\\?ref=(?<currentValue>.+)$/\n);\n\nexport function extractResource(base: string): PackageDependency | null {\n  let match: RegExpExecArray | null;\n\n  if (base.includes('_git')) {\n    match = underscoreGitRegex.exec(base);\n  } else if (base.includes('.git')) {\n    match = dotGitRegex.exec(base);\n  } else if (gitUrlWithPath.test(base)) {\n    match = gitUrlWithPath.exec(base);\n  } else {\n    match = gitUrl.exec(base);\n  }\n\n  if (!match?.groups) {\n    return null;\n  }\n\n  const { path } = match.groups;\n  if (regEx(/(?:github\\.com)(:|\\/)/).test(path)) {\n    return {\n      currentValue: match.groups.currentValue,\n      datasource: GithubTagsDatasource.id,\n      depName: match.groups.project.replace('.git', ''),\n    };\n  }\n\n  return {\n    datasource: GitTagsDatasource.id,\n    depName: path.replace('.git', ''),\n    packageName: match.groups.url,\n    currentValue: match.groups.currentValue,\n  };\n}\n\nexport function extractImage(image: Image): PackageDependency | null {\n  if (!image.name) {\n    return null;\n  }\n  const nameDep = splitImageParts(image.newName ?? image.name);\n  const { depName } = nameDep;\n  const { digest, newTag } = image;\n  if (digest && newTag) {\n    logger.debug(\n      { newTag, digest },\n      'Kustomize ignores newTag when digest is provided. Pick one, or use `newTag: tag@digest`'\n    );\n    return {\n      depName,\n      currentValue: newTag,\n      currentDigest: digest,\n      skipReason: 'invalid-dependency-specification',\n    };\n  }\n\n  if (digest) {\n    if (!is.string(digest) || !digest.startsWith('sha256:')) {\n      return {\n        depName,\n        currentValue: digest,\n        skipReason: 'invalid-value',\n      };\n    }\n\n    return {\n      datasource: DockerDatasource.id,\n      depName,\n      currentValue: nameDep.currentValue,\n      currentDigest: digest,\n      replaceString: digest,\n    };\n  }\n\n  if (newTag) {\n    if (!is.string(newTag) || newTag.startsWith('sha256:')) {\n      return {\n        depName,\n        currentValue: newTag,\n        skipReason: 'invalid-value',\n      };\n    }\n\n    // TODO: types (#7154)\n    // eslint-disable-next-line @typescript-eslint/restrict-template-expressions\n    const dep = splitImageParts(`${depName}:${newTag}`);\n    return {\n      ...dep,\n      datasource: DockerDatasource.id,\n      replaceString: newTag,\n    };\n  }\n\n  if (image.newName) {\n    return {\n      ...nameDep,\n      datasource: DockerDatasource.id,\n      replaceString: image.newName,\n    };\n  }\n\n  return null;\n}\n\nexport function extractHelmChart(\n  helmChart: HelmChart\n): PackageDependency | null {\n  if (!helmChart.name) {\n    return null;\n  }\n\n  return {\n    depName: helmChart.name,\n    currentValue: helmChart.version,\n    registryUrls: [helmChart.repo],\n    datasource: HelmDatasource.id,\n  };\n}\n\nexport function parseKustomize(\n  content: string,\n  packageFile?: string\n): Kustomize | null {\n  let pkg: Kustomize | null = null;\n  try {\n    pkg = load(content, { json: true }) as Kustomize;\n  } catch (e) /* istanbul ignore next */ {\n    logger.debug({ packageFile }, 'Error parsing kustomize file');\n    return null;\n  }\n\n  if (!pkg || is.string(pkg)) {\n    return null;\n  }\n\n  pkg.kind ??= 'Kustomization';\n\n  if (!['Kustomization', 'Component'].includes(pkg.kind)) {\n    return null;\n  }\n\n  return pkg;\n}\n\nexport function extractPackageFile(\n  content: string,\n  packageFile?: string // TODO: fix tests\n): PackageFileContent | null {\n  logger.trace(`kustomize.extractPackageFile(${packageFile!})`);\n  const deps: PackageDependency[] = [];\n\n  const pkg = parseKustomize(content, packageFile);\n  if (!pkg) {\n    return null;\n  }\n\n  // grab the remote bases\n  for (const base of coerceArray(pkg.bases).filter(is.string)) {\n    const dep = extractResource(base);\n    if (dep) {\n      deps.push({\n        ...dep,\n        depType: pkg.kind,\n      });\n    }\n  }\n\n  // grab the remote resources\n  for (const resource of coerceArray(pkg.resources).filter(is.string)) {\n    const dep = extractResource(resource);\n    if (dep) {\n      deps.push({\n        ...dep,\n        depType: pkg.kind,\n      });\n    }\n  }\n\n  // grab the remote components\n  for (const component of coerceArray(pkg.components).filter(is.string)) {\n    const dep = extractResource(component);\n    if (dep) {\n      deps.push({\n        ...dep,\n        depType: pkg.kind,\n      });\n    }\n  }\n\n  // grab the image tags\n  for (const image of coerceArray(pkg.images)) {\n    const dep = extractImage(image);\n    if (dep) {\n      deps.push({\n        ...dep,\n        depType: pkg.kind,\n      });\n    }\n  }\n\n  // grab the helm charts\n  for (const helmChart of coerceArray(pkg.helmCharts)) {\n    const dep = extractHelmChart(helmChart);\n    if (dep) {\n      deps.push({\n        ...dep,\n        depType: 'HelmChart',\n      });\n    }\n  }\n\n  if (!deps.length) {\n    return null;\n  }\n  return { deps };\n}\n"]}