{"version":3,"file":"artifacts.js","sourceRoot":"","sources":["../../../../lib/modules/manager/pipenv/artifacts.ts"],"names":[],"mappings":"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","sourcesContent":["import { TEMPORARY_ERROR } from '../../../constants/error-messages';\nimport { logger } from '../../../logger';\nimport { exec } from '../../../util/exec';\nimport type { ExecOptions } from '../../../util/exec/types';\nimport {\n  deleteLocalFile,\n  ensureCacheDir,\n  readLocalFile,\n  writeLocalFile,\n} from '../../../util/fs';\nimport { getRepoStatus } from '../../../util/git';\nimport type {\n  UpdateArtifact,\n  UpdateArtifactsConfig,\n  UpdateArtifactsResult,\n} from '../types';\nimport { PipfileLockSchema } from './schema';\n\nexport function getPythonConstraint(\n  existingLockFileContent: string,\n  config: UpdateArtifactsConfig\n): string | undefined {\n  const { constraints = {} } = config;\n  const { python } = constraints;\n\n  if (python) {\n    logger.debug('Using python constraint from config');\n    return python;\n  }\n  try {\n    const result = PipfileLockSchema.safeParse(\n      JSON.parse(existingLockFileContent)\n    );\n    // istanbul ignore if: not easily testable\n    if (!result.success) {\n      logger.warn({ error: result.error }, 'Invalid Pipfile.lock');\n      return undefined;\n    }\n    if (result.data._meta?.requires?.python_version) {\n      const pythonVersion = result.data._meta.requires.python_version;\n      return `== ${pythonVersion}.*`;\n    }\n    if (result.data._meta?.requires?.python_full_version) {\n      const pythonFullVersion = result.data._meta.requires.python_full_version;\n      return `== ${pythonFullVersion}`;\n    }\n  } catch (err) {\n    // Do nothing\n  }\n  return undefined;\n}\n\nexport function getPipenvConstraint(\n  existingLockFileContent: string,\n  config: UpdateArtifactsConfig\n): string {\n  const { constraints = {} } = config;\n  const { pipenv } = constraints;\n\n  if (pipenv) {\n    logger.debug('Using pipenv constraint from config');\n    return pipenv;\n  }\n  try {\n    const result = PipfileLockSchema.safeParse(\n      JSON.parse(existingLockFileContent)\n    );\n    // istanbul ignore if: not easily testable\n    if (!result.success) {\n      logger.warn({ error: result.error }, 'Invalid Pipfile.lock');\n      return '';\n    }\n    if (result.data.default?.pipenv?.version) {\n      return result.data.default.pipenv.version;\n    }\n    if (result.data.develop?.pipenv?.version) {\n      return result.data.develop.pipenv.version;\n    }\n  } catch (err) {\n    // Do nothing\n  }\n  return '';\n}\n\nexport async function updateArtifacts({\n  packageFileName: pipfileName,\n  newPackageFileContent: newPipfileContent,\n  config,\n}: UpdateArtifact): Promise<UpdateArtifactsResult[] | null> {\n  logger.debug(`pipenv.updateArtifacts(${pipfileName})`);\n\n  const lockFileName = pipfileName + '.lock';\n  const existingLockFileContent = await readLocalFile(lockFileName, 'utf8');\n  if (!existingLockFileContent) {\n    logger.debug('No Pipfile.lock found');\n    return null;\n  }\n  try {\n    await writeLocalFile(pipfileName, newPipfileContent);\n    if (config.isLockFileMaintenance) {\n      await deleteLocalFile(lockFileName);\n    }\n    const cmd = 'pipenv lock';\n    const tagConstraint = getPythonConstraint(existingLockFileContent, config);\n    const pipenvConstraint = getPipenvConstraint(\n      existingLockFileContent,\n      config\n    );\n    const execOptions: ExecOptions = {\n      cwdFile: pipfileName,\n      extraEnv: {\n        PIPENV_CACHE_DIR: await ensureCacheDir('pipenv'),\n        PIP_CACHE_DIR: await ensureCacheDir('pip'),\n      },\n      docker: {},\n      toolConstraints: [\n        {\n          toolName: 'python',\n          constraint: tagConstraint,\n        },\n        {\n          toolName: 'pipenv',\n          constraint: pipenvConstraint,\n        },\n      ],\n    };\n    logger.trace({ cmd }, 'pipenv lock command');\n    await exec(cmd, execOptions);\n    const status = await getRepoStatus();\n    if (!status?.modified.includes(lockFileName)) {\n      return null;\n    }\n    logger.debug('Returning updated Pipfile.lock');\n    return [\n      {\n        file: {\n          type: 'addition',\n          path: lockFileName,\n          contents: await readLocalFile(lockFileName, 'utf8'),\n        },\n      },\n    ];\n  } catch (err) {\n    // istanbul ignore if\n    if (err.message === TEMPORARY_ERROR) {\n      throw err;\n    }\n    logger.debug({ err }, 'Failed to update Pipfile.lock');\n    return [\n      {\n        artifactError: {\n          lockFile: lockFileName,\n          stderr: err.message,\n        },\n      },\n    ];\n  }\n}\n"]}