{"version":3,"file":"context.js","sourceRoot":"","sources":["../../../../lib/modules/manager/bazel-module/context.ts"],"names":[],"mappings":";;;;AAMA,+DAAyC;AAQzC,MAAa,kBAAmB,SAAQ,KAAK;IAClC,OAAO,CAAe;IACtB,MAAM,CAAgB;IAC/B,YAAY,OAAqB,EAAE,MAAqB;QACtD,MAAM,GAAG,GAAG,mCAAmC,OAAO,CAAC,IAAI,aACzD,MAAM,EAAE,IAAI,IAAI,MAClB,EAAE,CAAC;QACH,KAAK,CAAC,GAAG,CAAC,CAAC;QACX,IAAI,CAAC,IAAI,GAAG,oBAAoB,CAAC;QACjC,IAAI,CAAC,OAAO,GAAG,OAAO,CAAC;QACvB,IAAI,CAAC,MAAM,GAAG,MAAM,CAAC;IACvB,CAAC;CACF;AAZD,gDAYC;AAED,MAAa,GAAG;IACd,OAAO,CAAmB;IAC1B,KAAK,CAAiB;IAEtB,YAAY,UAA4B,EAAE,EAAE,QAAwB,EAAE;QACpE,IAAI,CAAC,OAAO,GAAG,OAAO,CAAC;QACvB,IAAI,CAAC,KAAK,GAAG,KAAK,CAAC;IACrB,CAAC;IAED,IAAY,WAAW;QACrB,OAAO,IAAI,CAAC,KAAK,CAAC,EAAE,CAAC,CAAC,CAAC,CAAC,CAAC;IAC3B,CAAC;IAED,IAAY,OAAO;QACjB,MAAM,CAAC,GAAG,IAAI,CAAC,WAAW,CAAC;QAC3B,IAAI,CAAC,KAAK,SAAS,EAAE;YACnB,MAAM,IAAI,KAAK,CAAC,kCAAkC,CAAC,CAAC;SACrD;QACD,OAAO,CAAC,CAAC;IACX,CAAC;IACD,IAAI,aAAa;QACf,MAAM,OAAO,GAAG,IAAI,CAAC,OAAO,CAAC;QAC7B,IAAI,OAAO,CAAC,IAAI,KAAK,QAAQ,EAAE;YAC7B,OAAO,OAAO,CAAC;SAChB;QACD,MAAM,IAAI,KAAK,CAAC,+CAA+C,CAAC,CAAC;IACnE,CAAC;IAED,IAAI,YAAY;QACd,MAAM,OAAO,GAAG,IAAI,CAAC,OAAO,CAAC;QAC7B,IAAI,OAAO,CAAC,IAAI,KAAK,OAAO,EAAE;YAC5B,OAAO,OAAO,CAAC;SAChB;QACD,MAAM,IAAI,KAAK,CAAC,8CAA8C,CAAC,CAAC;IAClE,CAAC;IAEO,QAAQ;QACd,MAAM,OAAO,GAAG,IAAI,CAAC,KAAK,CAAC,GAAG,EAAE,CAAC;QACjC,IAAI,CAAC,OAAO,EAAE;YACZ,OAAO,KAAK,CAAC;SACd;QACD,IAAI,CAAC,OAAO,CAAC,UAAU,EAAE;YACvB,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;YACzB,OAAO,KAAK,CAAC;SACd;QACD,MAAM,MAAM,GAAG,IAAI,CAAC,WAAW,CAAC;QAEhC,IAAI,MAAM,EAAE;YACV,IAAI,MAAM,CAAC,IAAI,KAAK,WAAW,IAAI,SAAS,CAAC,OAAO,CAAC,OAAO,CAAC,EAAE;gBAC7D,MAAM,CAAC,KAAK,GAAG,OAAO,CAAC;gBACvB,MAAM,CAAC,UAAU,GAAG,IAAI,CAAC;gBACzB,OAAO,IAAI,CAAC;aACb;YACD,IAAI,MAAM,CAAC,IAAI,KAAK,OAAO,IAAI,SAAS,CAAC,WAAW,CAAC,OAAO,CAAC,EAAE;gBAC7D,MAAM,CAAC,KAAK,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;gBAC3B,OAAO,IAAI,CAAC;aACb;YACD,IACE,MAAM,CAAC,IAAI,KAAK,QAAQ;gBACxB,OAAO,CAAC,IAAI,KAAK,WAAW;gBAC5B,OAAO,CAAC,KAAK,KAAK,SAAS,EAC3B;gBACA,MAAM,CAAC,QAAQ,CAAC,OAAO,CAAC,IAAI,CAAC,GAAG,OAAO,CAAC,KAAK,CAAC;gBAC9C,OAAO,IAAI,CAAC;aACb;SACF;aAAM,IAAI,OAAO,CAAC,IAAI,KAAK,QAAQ,EAAE;YACpC,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;YAC3B,OAAO,IAAI,CAAC;SACb;QAED,MAAM,IAAI,kBAAkB,CAAC,OAAO,EAAE,MAAM,CAAC,CAAC;IAChD,CAAC;IAEO,YAAY;QAClB,OAAO,IAAI,CAAC,QAAQ,EAAE,EAAE;YACtB,gBAAgB;SACjB;QACD,OAAO,IAAI,CAAC;IACd,CAAC;IAED,SAAS,CAAC,KAAa;QACrB,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,SAAS,CAAC,MAAM,CAAC,KAAK,CAAC,CAAC,CAAC;QACzC,OAAO,IAAI,CAAC,YAAY,EAAE,CAAC;IAC7B,CAAC;IAED,UAAU,CAAC,KAAuB;QAChC,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,SAAS,CAAC,OAAO,CAAC,KAAK,CAAC,CAAC,CAAC;QAC1C,OAAO,IAAI,CAAC,YAAY,EAAE,CAAC;IAC7B,CAAC;IAED,WAAW,CAAC,WAA2B,EAAE;QACvC,MAAM,MAAM,GAAG,SAAS,CAAC,MAAM,CAAC,QAAQ,CAAC,CAAC;QAC1C,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC;QACxB,OAAO,IAAI,CAAC;IACd,CAAC;IAED,SAAS;QACP,MAAM,MAAM,GAAG,IAAI,CAAC,aAAa,CAAC;QAClC,MAAM,CAAC,UAAU,GAAG,IAAI,CAAC;QACzB,OAAO,IAAI,CAAC,YAAY,EAAE,CAAC;IAC7B,CAAC;IAED,SAAS,CAAC,IAAY;QACpB,OAAO,IAAI,CAAC,WAAW,CAAC,EAAE,IAAI,EAAE,SAAS,CAAC,MAAM,CAAC,IAAI,CAAC,EAAE,CAAC,CAAC;IAC5D,CAAC;IAED,OAAO;QACL,OAAO,IAAI,CAAC,SAAS,EAAE,CAAC;IAC1B,CAAC;IAED,cAAc,CAAC,IAAY;QACzB,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,SAAS,CAAC,SAAS,CAAC,IAAI,CAAC,CAAC,CAAC;QAC3C,OAAO,IAAI,CAAC,YAAY,EAAE,CAAC;IAC7B,CAAC;IAED,UAAU;QACR,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,SAAS,CAAC,KAAK,EAAE,CAAC,CAAC;QACnC,OAAO,IAAI,CAAC,YAAY,EAAE,CAAC;IAC7B,CAAC;IAED,QAAQ;QACN,MAAM,KAAK,GAAG,IAAI,CAAC,YAAY,CAAC;QAChC,KAAK,CAAC,UAAU,GAAG,IAAI,CAAC;QACxB,OAAO,IAAI,CAAC,YAAY,EAAE,CAAC;IAC7B,CAAC;CACF;AA7HD,kBA6HC","sourcesContent":["import type {\n  AllFragments,\n  ArrayFragment,\n  ChildFragments,\n  RecordFragment,\n} from './fragments';\nimport * as fragments from './fragments';\n\n// Represents the fields that the context must have.\nexport interface CtxCompatible {\n  results: RecordFragment[];\n  stack: AllFragments[];\n}\n\nexport class CtxProcessingError extends Error {\n  readonly current: AllFragments;\n  readonly parent?: AllFragments;\n  constructor(current: AllFragments, parent?: AllFragments) {\n    const msg = `Invalid context state. current: ${current.type}, parent: ${\n      parent?.type ?? 'none'\n    }`;\n    super(msg);\n    this.name = 'CtxProcessingError';\n    this.current = current;\n    this.parent = parent;\n  }\n}\n\nexport class Ctx implements CtxCompatible {\n  results: RecordFragment[];\n  stack: AllFragments[];\n\n  constructor(results: RecordFragment[] = [], stack: AllFragments[] = []) {\n    this.results = results;\n    this.stack = stack;\n  }\n\n  private get safeCurrent(): AllFragments | undefined {\n    return this.stack.at(-1);\n  }\n\n  private get current(): AllFragments {\n    const c = this.safeCurrent;\n    if (c === undefined) {\n      throw new Error('Requested current, but no value.');\n    }\n    return c;\n  }\n  get currentRecord(): RecordFragment {\n    const current = this.current;\n    if (current.type === 'record') {\n      return current;\n    }\n    throw new Error('Requested current record, but does not exist.');\n  }\n\n  get currentArray(): ArrayFragment {\n    const current = this.current;\n    if (current.type === 'array') {\n      return current;\n    }\n    throw new Error('Requested current array, but does not exist.');\n  }\n\n  private popStack(): boolean {\n    const current = this.stack.pop();\n    if (!current) {\n      return false;\n    }\n    if (!current.isComplete) {\n      this.stack.push(current);\n      return false;\n    }\n    const parent = this.safeCurrent;\n\n    if (parent) {\n      if (parent.type === 'attribute' && fragments.isValue(current)) {\n        parent.value = current;\n        parent.isComplete = true;\n        return true;\n      }\n      if (parent.type === 'array' && fragments.isPrimitive(current)) {\n        parent.items.push(current);\n        return true;\n      }\n      if (\n        parent.type === 'record' &&\n        current.type === 'attribute' &&\n        current.value !== undefined\n      ) {\n        parent.children[current.name] = current.value;\n        return true;\n      }\n    } else if (current.type === 'record') {\n      this.results.push(current);\n      return true;\n    }\n\n    throw new CtxProcessingError(current, parent);\n  }\n\n  private processStack(): Ctx {\n    while (this.popStack()) {\n      // Nothing to do\n    }\n    return this;\n  }\n\n  addString(value: string): Ctx {\n    this.stack.push(fragments.string(value));\n    return this.processStack();\n  }\n\n  addBoolean(value: string | boolean): Ctx {\n    this.stack.push(fragments.boolean(value));\n    return this.processStack();\n  }\n\n  startRecord(children: ChildFragments = {}): Ctx {\n    const record = fragments.record(children);\n    this.stack.push(record);\n    return this;\n  }\n\n  endRecord(): Ctx {\n    const record = this.currentRecord;\n    record.isComplete = true;\n    return this.processStack();\n  }\n\n  startRule(name: string): Ctx {\n    return this.startRecord({ rule: fragments.string(name) });\n  }\n\n  endRule(): Ctx {\n    return this.endRecord();\n  }\n\n  startAttribute(name: string): Ctx {\n    this.stack.push(fragments.attribute(name));\n    return this.processStack();\n  }\n\n  startArray(): Ctx {\n    this.stack.push(fragments.array());\n    return this.processStack();\n  }\n\n  endArray(): Ctx {\n    const array = this.currentArray;\n    array.isComplete = true;\n    return this.processStack();\n  }\n}\n"]}